<!DOCTYPE html>
<html>
  <head>
    <title>Parameter 'Nam</title>
    <link href='http://fonts.googleapis.com/css?family=Arvo&v2' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Kameron&v2' rel='stylesheet' type='text/css'>
    <link rel='stylesheet' href='/css/screen.css'></link>
    <link rel='stylesheet' href='/css/highlight.css'></link>
  </head>
  <body>
    <div class='header'>
        <a class='header-text' href='/'>mcramm.com</a>
            <div class='buttons'>
                <a href='https://github.com/mcramm'><img src='https://lh4.googleusercontent.com/-5_8rnYH_YbA/ToZRB70imlI/AAAAAAAAAr4/0X5KbQ1gWlA/s288/Octocat.png' width='40px'/></a>
                <a href='http://twitter.com/cramm'><img src='https://lh6.googleusercontent.com/-F-Qtu1RTa5s/ToZRCLErIbI/AAAAAAAAAr8/IboN5dcHCJo/s288/twitter_newbird_blue.png' width='40px'/></a>
            </div>
    </div>
    <div class ='sidebar'>
    <div class='navigation'>
        <a href='/'>About</a>
        <a class='current' href='/posts.html'>Posts</a>
    </div>
</div>
<div class='content'>
    <h1>Parameter 'Nam </h1>
    <p>Short projects are fun. Long projects <em>sound</em> fun, but can get pretty arduous towards the end. Strap on a deadline, and a couple managers breathing down your neck and you&#8217;ve got yourself a recipe for some pretty shitty code.</p>

<p>This was a project that I finished recently and was forced to rush during the last few weeks to get it out the door in time. Thankfully I was given some time recently to go back over it and refactor anything that I can before my next project starts. This project was centered around drawing dynamic text to a PDF over and over again. The text itself could be aligned to the left/center/right and required some funky math to re-position it based on that attribute. Since I was on a deadline and coding like a madman, I came up with this solution:</p>

<p><em>Note: The original project was done in php. I&#8217;ve transposed it to ruby for the sake of simplicity and syntax highlighting</em></p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>drawStaticText</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>y</span><span class='p'>,</span> <span class='n'>page</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>,</span> <span class='n'>html_color</span><span class='o'>=</span><span class='s2'>&quot;#000000&quot;</span><span class='p'>,</span> <span class='n'>fontSize</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>)</span>
  <span class='n'>fontSize</span> <span class='o'>=</span> <span class='p'>(</span><span class='n'>fontSize</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>?</span> <span class='nb'>self</span><span class='o'>.</span><span class='n'>fontSize</span> <span class='p'>:</span> <span class='n'>fontSize</span>
  <span class='n'>getPage</span><span class='p'>(</span><span class='n'>page</span><span class='p'>)</span>

  <span class='n'>setColor</span><span class='p'>(</span><span class='n'>html_color</span><span class='p'>)</span>
  <span class='nb'>self</span><span class='o'>.</span><span class='n'>page</span><span class='o'>.</span><span class='n'>setFont</span><span class='p'>(</span><span class='n'>getFont</span><span class='p'>(),</span> <span class='n'>fontSize</span><span class='p'>)</span>

  <span class='nb'>self</span><span class='o'>.</span><span class='n'>page</span><span class='o'>.</span><span class='n'>drawText</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>y</span><span class='p'>,</span> <span class='s1'>&#39;UTF-8&#39;</span><span class='p'>)</span>
<span class='k'>end</span>

<span class='k'>def</span> <span class='nf'>drawCenteredText</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>y</span><span class='p'>,</span> <span class='n'>page</span><span class='p'>,</span> <span class='n'>html_color</span><span class='o'>=</span><span class='s2'>&quot;#000000&quot;</span><span class='p'>,</span> <span class='n'>font_size</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>)</span>
  <span class='n'>font_size</span> <span class='o'>=</span> <span class='p'>(</span><span class='n'>font_size</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>?</span> <span class='nb'>self</span><span class='o'>.</span><span class='n'>fontSize</span> <span class='p'>:</span> <span class='n'>font_size</span>

  <span class='n'>width</span> <span class='o'>=</span> <span class='n'>getTextWidth</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>getFont</span><span class='p'>(),</span> <span class='n'>font_size</span><span class='p'>)</span>
  <span class='n'>x</span> <span class='o'>=</span> <span class='n'>x</span> <span class='o'>-</span> <span class='n'>width</span> <span class='o'>/</span> <span class='mi'>2</span>

  <span class='n'>drawStaticText</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>y</span><span class='p'>,</span> <span class='n'>page</span><span class='p'>,</span> <span class='n'>html_color</span><span class='p'>,</span> <span class='n'>font_size</span><span class='p'>)</span>
<span class='k'>end</span>

<span class='k'>def</span> <span class='nf'>drawRightAlignedText</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>y</span><span class='p'>,</span> <span class='n'>page</span><span class='p'>,</span> <span class='n'>html_color</span><span class='o'>=</span><span class='s2'>&quot;#000000&quot;</span><span class='p'>,</span> <span class='n'>font_size</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>)</span>
  <span class='n'>font_size</span> <span class='o'>=</span> <span class='p'>(</span><span class='n'>font_size</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>?</span> <span class='nb'>self</span><span class='o'>.</span><span class='n'>fontSize</span> <span class='p'>:</span> <span class='n'>font_size</span>

  <span class='n'>width</span> <span class='o'>=</span> <span class='n'>getTextWidth</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>getFont</span><span class='p'>(),</span> <span class='n'>font_size</span><span class='p'>)</span>
  <span class='n'>x</span> <span class='o'>=</span> <span class='n'>x</span> <span class='o'>-</span> <span class='n'>width</span>

  <span class='n'>drawStaticText</span><span class='p'>(</span><span class='n'>text</span><span class='p'>,</span> <span class='n'>x</span><span class='p'>,</span> <span class='n'>y</span><span class='p'>,</span> <span class='n'>page</span><span class='p'>,</span> <span class='n'>html_color</span><span class='p'>,</span> <span class='n'>font_size</span><span class='p'>)</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Ack! Look at that mess! I can see at least 3 things wrong here:</p>

<h3 id='1_code_duplication'>1. Code Duplication</h3>

<p>I&#8217;m doing a few things over and over again in each of these methods. The bottom two are even calling <code>drawStaticText</code>, which is defaulting the <code>fontSize</code> yet again!</p>

<p><code>getTextWidth()</code> is also being called twice in order the get the text&#8217;s width. This is required to reposition the text on the page based on the alignment.</p>

<h3 id='2_poorly_named_methods'>2. Poorly named methods</h3>

<p>The names of these methods aren&#8217;t consistent, nor do I feel the correctly convey what they&#8217;re doing. The person implmenting this code might not have a problem understanding what <code>drawCenteredText</code>, does, but it would feel inconsistant next to <code>drawRightAlignedText</code>. And why the word &#8220;Static&#8221; in <code>drawStaticText</code>? What does that imply about the method?</p>

<p>I might just be nitpicking here, but I think these methods should be renamed and/or removed if possible.</p>

<h3 id='3_parameter_hell'>3. Parameter Hell</h3>

<p>Wow. There are way too many parameters being passed around here. Some people regrard the passing of more than 2 parameters as a code smell, and I tend to agree. If you&#8217;re passing in 3 or more parameters to a method, then you should think about different ways of doing what you want to accomplish. Maybe you can split the method out into two smaller methods, or maybe you can modify some logic within the method to reduce the requirement of so many parameters. In any case, there is almost always a better solution that will not only simplify/reduce your code, but also make it easier to test.</p>

<p>My focus for the remainder of this post is getting rid of those crazy parameters from the example. These methods depend upon an underlying library (<a href='http://framework.zend.com/manual/en/zend.pdf.html'>Zend</a>) to render the pdf onto the page. This is called through the <code>self.page.drawText()</code> method, and I won&#8217;t be able to modify it without having to change a base lbrary that may be used by others. This means I&#8217;ll be forced to pass in a number of parameters to this method at some point. I&#8217;ll need to find a way of reducing the number of parameters being passed in, and yet still provide the necessary information to the underlying library.</p>

<p>I recently got Martin Fowler&#8217;s &#8220;Refactoring: Improving the Design of Existing Code&#8221;, and it has been an amazing source of information for refactorings like this. On page 295, it details the process of replacing a number of parameters sent to a method with a parameter <em>object</em> instead:</p>

<blockquote>
<p>Often you see a particular group of parameters that tend to be passed together. Several methods may use this group, either on one calss or in several classes. Such a group of classes is a data clump that can be replaced with an object that carries all of this data.</p>
</blockquote>

<p>Besides just removing the number of parameters (which may cause problems for anyone else implmenting this code), you get the added benefit of (possibly) being able to move some business logic into the object itself, having an easier to read/implment method call, and testing this class just became a lot easier.</p>

<p>This seemed relativly trivial to do, and here is the resulting code:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>TextObject</span>
  <span class='no'>ATTRIBUTES</span> <span class='o'>=</span> <span class='o'>[</span>
    <span class='ss'>:value</span><span class='p'>,</span> <span class='ss'>:x</span><span class='p'>,</span> <span class='ss'>:y</span><span class='p'>,</span> <span class='ss'>:alignment</span><span class='p'>,</span> <span class='ss'>:color</span><span class='p'>,</span> <span class='ss'>:font_size</span>
  <span class='o'>].</span><span class='n'>freeze</span>

  <span class='no'>ATTRIBUTES</span><span class='o'>.</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='kp'>attr</span><span class='o'>|</span>
    <span class='kp'>attr_accessor</span> <span class='kp'>attr</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>initialize</span><span class='p'>(</span><span class='n'>args</span><span class='o'>=</span><span class='kp'>nil</span><span class='p'>)</span>
    <span class='no'>ATTRIBUTES</span><span class='o'>.</span><span class='n'>each</span> <span class='k'>do</span> <span class='o'>|</span><span class='kp'>attr</span><span class='o'>|</span>
      <span class='k'>if</span><span class='p'>(</span> <span class='n'>args</span><span class='o'>.</span><span class='n'>key?</span><span class='p'>(</span><span class='kp'>attr</span><span class='p'>)</span> <span class='p'>)</span>
        <span class='nb'>instance_variable_set</span><span class='p'>(</span><span class='s2'>&quot;@</span><span class='si'>#{</span><span class='kp'>attr</span><span class='si'>}</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='n'>args</span><span class='o'>[</span><span class='kp'>attr</span><span class='o'>]</span><span class='p'>)</span>
      <span class='k'>end</span>
    <span class='k'>end</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>x</span>
    <span class='k'>return</span> <span class='n'>x</span> <span class='k'>unless</span> <span class='o'>[</span><span class='ss'>:right</span><span class='p'>,</span> <span class='ss'>:center</span><span class='o'>].</span><span class='n'>include?</span> <span class='nb'>self</span><span class='o'>.</span><span class='n'>alignment</span>
    <span class='k'>return</span> <span class='p'>(</span><span class='nb'>self</span><span class='o'>.</span><span class='n'>alignment</span> <span class='o'>==</span> <span class='ss'>:right</span><span class='p'>)</span> <span class='p'>?</span> <span class='n'>calculateOffsetForRight</span> <span class='p'>:</span> <span class='n'>calculateOffsetForCenter</span>
  <span class='k'>end</span>

  <span class='kp'>private</span>

  <span class='k'>def</span> <span class='nf'>calculateOffsetForRight</span>
    <span class='k'>return</span> <span class='n'>x</span> <span class='o'>-</span> <span class='n'>getWidth</span><span class='p'>()</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>calculateOffsetForCenter</span>
    <span class='k'>return</span> <span class='n'>x</span> <span class='o'>-</span> <span class='p'>(</span><span class='n'>getWidth</span><span class='p'>()</span> <span class='o'>/</span> <span class='mi'>2</span><span class='p'>)</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nf'>getWidth</span>
    <span class='k'>return</span> <span class='nb'>self</span><span class='o'>.</span><span class='n'>value</span><span class='o'>.</span><span class='n'>size</span>
    <span class='c1'># In reality, this method returns pixel value for the string based on font size / family.</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>You can see that not only did I move all of the required parameters into attributes themselves, but I also added in the <code>calculateOffsetForRight</code> and <code>calculateOffsetForCenter</code> methods that should remove the requirement of having two slightly different methods higher up. Both of these methods simply return the <code>x</code> value that the text should start at based upon it&#8217;s width.</p>

<p>Now, thankfully, I can remove the needed parameters from the list, as well as the two other duplicated methods. At the same time, I&#8217;ll rename <code>drawStaticText</code> to <code>drawText</code> to better reflect what it is doing.</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>drawText</span><span class='p'>(</span> <span class='n'>text_obj</span><span class='p'>,</span> <span class='n'>page</span><span class='o'>=</span><span class='mi'>1</span> <span class='p'>)</span>
  <span class='n'>font_size</span> <span class='o'>=</span> <span class='p'>(</span><span class='n'>textObj</span><span class='o'>.</span><span class='n'>font_size</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span> <span class='p'>?</span> <span class='nb'>self</span><span class='o'>.</span><span class='n'>font_size</span> <span class='p'>:</span> <span class='n'>text_obj</span><span class='o'>.</span><span class='n'>font_size</span>
  <span class='n'>getPage</span><span class='p'>(</span><span class='n'>page</span><span class='p'>)</span>
  <span class='n'>setColor</span><span class='p'>(</span><span class='n'>text_obj</span><span class='o'>.</span><span class='n'>color</span><span class='p'>)</span>
  <span class='nb'>self</span><span class='o'>.</span><span class='n'>page</span><span class='o'>.</span><span class='n'>setFont</span><span class='p'>(</span><span class='n'>get_font</span><span class='p'>(),</span> <span class='n'>font_size</span><span class='p'>)</span>
  <span class='nb'>self</span><span class='o'>.</span><span class='n'>page</span><span class='o'>.</span><span class='n'>drawText</span><span class='p'>(</span><span class='n'>text_obj</span><span class='o'>.</span><span class='n'>value</span><span class='p'>,</span> <span class='n'>text_obj</span><span class='o'>.</span><span class='n'>x</span><span class='p'>,</span> <span class='n'>text_obj</span><span class='o'>.</span><span class='n'>y</span><span class='p'>,</span> <span class='s1'>&#39;UTF-8&#39;</span><span class='p'>)</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Finally this code is starting to shape up. This is what it would look like to use that <code>TextObject</code>:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>my_text_obj</span> <span class='o'>=</span> <span class='kp'>new</span> <span class='no'>TextObject</span><span class='p'>({</span>
  <span class='ss'>:value</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;Draw Me!&quot;</span><span class='p'>,</span>
  <span class='ss'>:x</span> <span class='o'>=&gt;</span> <span class='mi'>12</span><span class='p'>,</span>
  <span class='ss'>:y</span> <span class='o'>=&gt;</span> <span class='mi'>100</span><span class='p'>,</span>
  <span class='ss'>:alignment</span> <span class='o'>=&gt;</span> <span class='ss'>:left</span><span class='p'>,</span>
  <span class='ss'>:color</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;#000000&quot;</span><span class='p'>,</span>
  <span class='ss'>:font_size</span> <span class='o'>=&gt;</span> <span class='mi'>12</span>
<span class='p'>})</span>

<span class='n'>my_text_obj</span><span class='o'>.</span><span class='n'>x</span>   <span class='c1'># =&gt; 12</span>

<span class='n'>my_text_obj</span><span class='o'>.</span><span class='n'>alignment</span> <span class='o'>=</span> <span class='ss'>:right</span>
<span class='n'>my_text_obj</span><span class='o'>.</span><span class='n'>x</span>   <span class='c1'># =&gt; 4</span>

<span class='n'>my_text_obj</span><span class='o'>.</span><span class='n'>alignment</span> <span class='o'>=</span> <span class='ss'>:center</span>
<span class='n'>my_text_obj</span><span class='o'>.</span><span class='n'>x</span>   <span class='c1'># =&gt; 8</span>

<span class='n'>drawText</span><span class='p'>(</span> <span class='n'>my_text_obj</span> <span class='p'>)</span>
</code></pre>
</div>
<p>I&#8217;m sure that there are other ways to refactor this code even further, but this is fine for the puroposes of getting rid of all those crazy parameters. Testing the <code>drawText</code> method now should be much easier, and I can write tests for the <code>TextObject</code> as well.</p>

<p>Hopfully when I am in a rush from this point on, I&#8217;ll try this solution first instead of writing method definations that require me to enable text-wrapping in VIM just so I can see them!</p>
</div>

</body>
</html>
